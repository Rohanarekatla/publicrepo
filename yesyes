# Data source to fetch all enterprise applications
data "azuread_service_principals" "all_apps" {
  # No filter here - we'll filter in locals
}

locals {
  # Read and process the groups file
  content         = file(var.config_file)
  lines           = split("\n", local.content)
  filtered_lines  = [for line in local.lines : line if line != ""]
  names           = [for line in local.filtered_lines : split(" ", line)[0]]

  # Filter enterprise apps that match the pattern
  matching_apps = [
    for app in data.azuread_service_principals.all_apps.service_principals : app
    if can(regex("^(?i)(ADP Azure|ADP AWS).*", app.display_name))
  ]

  # Create a map of all combinations of groups and apps
  group_app_combinations = flatten([
    for app in local.matching_apps : [
      for name in local.names : {
        group_name = name
        app       = app
      }
    ]
  ])
}

# Fetch AD groups
data "azuread_group" "group" {
  for_each     = toset(local.names)
  display_name = each.value
}

# Create role assignments for all combinations
resource "azuread_app_role_assignment" "group_assignment" {
  for_each = {
    for combo in local.group_app_combinations : 
    "${combo.group_name}-${combo.app.display_name}" => {
      group_name = combo.group_name
      app       = combo.app
    }
  }

  principal_object_id = data.azuread_group.group[each.value.group_name].id
  resource_object_id  = each.value.app.id
  app_role_id        = each.value.app.app_roles[0].id
}

# Variables
variable "config_file" {
  description = "Path to the groups configuration file"
  type        = string
  default     = "groups.input"
}